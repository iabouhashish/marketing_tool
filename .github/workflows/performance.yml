name: Performance Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'requirements*.txt'
  workflow_dispatch:

jobs:
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
        pip install pytest-benchmark memory-profiler
        pip install -e .
        
    - name: Run performance tests
      run: |
        pytest tests/ -v --benchmark-only --benchmark-sort=mean
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        
    - name: Memory usage test
      run: |
        python -m memory_profiler -c "
        from marketing_project.runner import run_marketing_project_pipeline
        print('Memory test completed')
        "

  load-test:
    name: Load Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install locust
        pip install -e .
        
    - name: Start server in background
      run: |
        marketing-project serve --host 0.0.0.0 --port 8000 &
        sleep 10
        
    - name: Run load test
      run: |
        locust --headless --users 10 --spawn-rate 2 --run-time 30s --host http://localhost:8000
